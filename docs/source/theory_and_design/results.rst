.. _theory-results:

Experimental results
====================

To verify the effectiveness of the test patterns generated by this software a
number of experiments have been carried out, the results of which are shown
here. Broadly, these experiments are divided into two groups which demonstrate
that:

* The heuristic synthesis test pattern performs better than a naive test
  pattern which assumes filter linearity.
* The generated test patterns produce more extreme signal levels than real
  pictures or noise signals in practice.


Heuristic vs naive synthesis test patterns
------------------------------------------

The heuristic developed in :ref:`theory-test-patterns` is designed to produce
more extreme signal values after quantisation than test patterns which ignore
non-linearities in VC-2. To verify this, the following experiment compares the
result of passing both types of synthesis test pattern through a VC-2 encoder
and decoder.

Method
``````

The following procedure is carried out for each synthesis filter phase (i.e.
for each test pattern):

1. Encode the pattern-under-test.
2. Quantise the transform coefficients produced in step 1.
3. Decode the quantised transform coefficients and record the signal value in
   the targeted part of the synthesis transform.
4. Repeat steps 2-3 for all quantisation indices which don't quantise all
   transform coefficients to zero.

Quantisation is carried out using a single quantisation index for all picture
slices and using the default quantisation matrix for the filter configuration
used.


Results
```````

The plot below shows the relative performance of the naive and heuristic test
patterns across all arrays and filter phases (see :ref:`terminology`), broken
down by transform depth and wavelet. Each dot shows the relative performance of
the test pattern for a particular filter phase.

.. image:: /_static/heuristic_improvement_all_phases.svg

In general, the heuristic test patterns produce signal levels roughly twice as
large as the naive test patterns, only rarely producing lower signal levels.
For certain filter arrays/phases, signal level increases of 3-4\ :math:`\times`
over the naive test patterns are possible.

.. note::

    The figure above treats each filter phase independently. In practice, most
    VC-2 implementations will choose a fixed number of bits for each array
    rather than assigning each filter phase a different number of bits. As the
    figure below illustrates, the signal ranges for a given array can vary
    substantially between filter phases:

    .. image:: /_static/filter_phase_test_pattern_variations.svg
    
    Because of this, it may make more sense to present the effect the heuristic
    test patterns have on the worst-case signal levels within each array. The
    plot is redrawn below but this time each dot represents the relative
    improvement of going from the most extreme value produced by the naive
    filter to the most extreme value for the heuristic filter..
    
    .. image:: /_static/heuristic_improvement_worst_case.svg
    
    This alternative perspective tells us that the heuristic test patterns have
    a less significant in general but that for some arrays the heuristic test
    patterns can still produce values 2-3\ :math:`\times` larger than naive
    patterns.


Comparison with natural images and noise
----------------------------------------

As noted in :ref:`theory-related-work`, a common approach to picking signal
widths in wavelet transforms is to pass images or noise through the filter and
observe signal levels in practice. To test the effectiveness of this approach,
an instrumented VC-2 encoder/decoder was used to log the signal levels produced
by such experiments as compared with those produced by the test patterns.


Method
``````

Experiments used the following input pictures:

* Real pictures (48 natural images)
    * YCbCr and RGB formats
    * 8, 10, 12 and 16 bit depth
    * UHD and HD resolution scalings

For a total of 2304 picture components (48 pictures :math:`\times` 6 picture
components (Y, Cb and Cr; R, G and B) :math:`\times` 4 bit depths
:math:`\times` 2 resolutions (UHD and HD).

* Noise signals (300 noise pictures)
    * Saturated and non-saturated uniform random (white) noise
    * 8, 10, 12 and 16 bit depth
    * HD resolution only

For a total of 2400 (monochrome) noise pictures (300 noise samples
:math:`\times` 2 noise types :math:`\times` 4 bit depths).

The following codec configurations were tested:

* Wavelet:
    * Haar (with shift)
    * Le Gall (5, 3)
    * Deslauriers-Dubuc (9, 7)
    * Deslauriers-Dubuc (13, 7)
    * Daubechies (9, 7)
    * Fidelity
* Transform depth
    * 2 levels (symmetric)
    * 4 levels (symmetric)
* Quantisation matrix
    * Default quantisation matrix used for the wavelet/depth chosen
* Quantisation index (applied globally to all picture slices)
    * All possible quantisation indices used

For a total of 768 codec configurations (6 wavelets :math:`\times` 2 transform
depths :math:`\times` (approx) 64 quantisation indices). This total is
approximate as the number of quantisation indices tested varies depending on
the picture being encoded.

Each component (channel) of every test picture and noise plate is individually
encoded (analysed), quantised and decoded (synthesised) using each
configuration of the codec enumerated above. In each of these runs, the peak
signal levels in each array in the encoder and decoder (see :ref:`terminology`)
are recorded.

In total approximately 3,612,672 picture component and codec configuration
combinations were tested (768 configurations :math:`\times` 2304 :math:`+` 2400
picture components).


Detailed Results
````````````````

Due to VC-2's flexibility, the experiments carried out include a fairly large
number of variables. Many of these variables have little impact on the general
trends in the results. As a consequence, we begin by looking at specific
examples which demonstrate general trends before exploring the effects of
different codec configurations.

General trends
~~~~~~~~~~~~~~

The plot below shows the worst-case signal levels in each array of a 4-level Le
Gall (5, 3) transform acting on 10 bit pictures.

.. image:: /_static/bit_widths_noise_vs_pictures.svg

..
    python ../signal-width-experiments/plot_signal_ranges.py \
        --title "4-level Le Gall (5, 3), 10-bit pictures" \
        --plot-upper-bound "Theoretical upper bound" le_gall_4_10bits.csv \
        --plot-test-pattern "Test pattern" le_gall_4_10bits.csv \
        --plot-picture "Real pictures" 2.5 \
            ../signal-width-experiments/results/images_ycbcr_16_hd_DSC_*_channel0_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture "Saturated noise" 2.5 \
            ../signal-width-experiments/results/saturated_noise_hd_seed*_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --output docs/source/_static/bit_widths_noise_vs_pictures.svg 297 110

The 'Theoretical upper bound' line gives the upper-bound computed according to
affine arithmetic (see :ref:`theory-affine-arithmetic`). The 'Test pattern'
line shows the signal levels reached by the test patterns generated by this
software (see :ref:`theory-test-patterns`).

In the analysis filter, the test patterns almost exactly reach the theoretical
upper bound. In the synthesis filter, however, quantisation causes the
theoretical upper bounds to grow well beyond the level of the test patterns. In
all codec configurations, the synthesis filter's theoretical upper bounds
appear to be significantly over-estimated (by several bits) compared with
signal levels observed in practice.

The 'Saturated noise' and 'Real pictures' lines show the signal levels reached
by saturated noise signals and real HD luma (Y) picture components
respectively. The lines show the mean peak signal across all pictures while the
error bars show the range. The results are shown for the quantisation index
which achieves an overall 4:1 compression ratio typical of VC-2 applications.

.. note::
    
    In these experiments, the encoder encodes the entire picture as a single
    picture slice using the lowest quantisation index which fits the required
    picture data. This is a simplification of real encoder behaviour necessary
    to keep the parameter space for these experiments under control.

A key result shown in this plot is that at every part of the analysis and
synthesis filters, the test patterns produce signal levels at least as large as
the pictures or noise. In many cases, the test patterns produce peak signal
levels over 1 bit larger than the pictures and noise. This means that had these
real pictures or noise been used to pick bit widths for a VC-2 implementation,
these would have under-estimated the required number of bits.

A secondary observation is that the ability of random noise signals to find
extreme signal levels reduces at deeper levels of the transform and also
following quantisation. In fact, this effect is so pronounced that at the
deepest part of the transform, real pictures actually produce more extreme
signal levels than the noise. This may be explained by these parts of the
transform being dominated by low-spatial-frequency content which natural
pictures are heavily skewed towards.


Effects of quantisation
~~~~~~~~~~~~~~~~~~~~~~~

The previous plot showed the signal levels reached when real pictures and noise
are passed through a VC-2 codec using quantisation indices consistent with a
typical 4:1 compression ratio. By design, the quantisation levels required to
achieve this level of compression produce only small errors. At higher
quantisation levels, larger errors are produced which can lead to more extreme
signal values being produced from real picture and noise signals.

To illustrate the relative effects of atypical-quantisation levels, the plot
below compares the signal levels produced for 4:1 compressed pictures and noise
and 'worst-case' quantisations of those same pictures.  The 'worst-case' values
report the most extreme signal value produced at *any* quantisation index.

.. image:: /_static/bit_widths_4to1_vs_worst_case_quantisation.svg

..
    python ../signal-width-experiments/plot_signal_ranges.py \
        --title "4-level Le Gall (5, 3), 10-bit pictures" \
        --plot-test-pattern "Test pattern" le_gall_4_10bits.csv \
        --plot-picture "Real pictures (4:1 compressed)" 2.5 \
            ../signal-width-experiments/results/images_ycbcr_16_hd_DSC_*_channel0_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture-worst-case "Real pictures (worst-case quantisation)" \
            ../signal-width-experiments/results/images_ycbcr_16_hd_DSC_*_channel0_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture "Saturated noise (4:1 compressed)" 2.5 \
            ../signal-width-experiments/results/saturated_noise_hd_seed*_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture-worst-case "Saturated noise (worst-case quantisation)" \
            ../signal-width-experiments/results/saturated_noise_hd_seed*_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --output docs/source/_static/bit_widths_4to1_vs_worst_case_quantisation.svg 297 110


As the plots show, worst-case quantisation produces consistently higher signal
levels than those found under 4:1 compression. Nevertheless, these signal
levels remain below the signal levels produced by the test patterns.

Once again, a 4-level Le Gall (5, 3) transform acting on 10 bit pictures is
shown above but the pattern is found to be consistent across other
configurations as is discussed in greater detail later.

.. note::

    The 'worst-case' quantisation levels used in the plot above are much higher
    than those used under typical compression ratios. The boxplots below
    illustrate the distributions of quantisation indices which are used in
    practice.

    .. image:: /_static/quantisation_index_distributions.svg

    The 'Test patterns' boxplot shows the distribution of quantisation indices
    used by the heuristic synthesis test patterns. The other box plots show the
    actual distributions of quantisation indices used to encode the test
    pictures and noise samples.

    The plots show that the quantisation levels used for real pictures at
    typical (i.e. 4:1) or even larger compression ratios (i.e. 6:1) are
    significantly lower than worst-case quantisation levels, and those levels
    used by the test patterns. Even in the case of noise signals, the
    quantisation levels used still fall short of these worst-case levels.

    The plot specifically shows the quantisation indices used by a 4-level Le
    Gall (5, 3) transform for 10 bit input signals however the general trend is
    consistent accross configurations.

This result implies that even if encoders are deliberately configured to use
very large quantisation levels, real pictures and noise signals still do not
produce the signal levels produced by the heuristic test patterns.



Noise types
~~~~~~~~~~~

The plot below compares the signal levels achieved by non-saturated and
saturated noise signals, shown for worst-case quantisation indices. Again, a
4-level Le Gall (5, 3) transform is shown acting on 10 bit inputs.

.. image:: /_static/bit_widths_saturated_vs_non_saturated_noise.svg

..
    python ../signal-width-experiments/plot_signal_ranges.py \
        --title "4-level Le Gall (5, 3), 10-bit pictures" \
        --plot-test-pattern "Test pattern" le_gall_4_10bits.csv \
        --plot-picture-worst-case "Saturated noise" \
            ../signal-width-experiments/results/saturated_noise_hd_seed*_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture-worst-case "Non-saturated noise" \
            ../signal-width-experiments/results/noise_hd_seed*_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --output docs/source/_static/bit_widths_saturated_vs_non_saturated_noise.svg 297 110

As might be expected, saturated noise results in higher worst-case signal
levels, a pattern found to be consistent across all arrays and all noise
samples and codec configurations tested. This confirms that saturated noise
makes a better test signal for finding extreme signal values than unsaturated
noise.

.. note::

    A singular exception to the rule that saturated noise produces larger
    signals than non-saturated noise was found in the experimental data.
    Specifically the final output stage of the 2-level Haar (with shift)
    synthesis transform, non-saturated noise produced worse-case signals around
    0.2 bits larger than saturated noise. Due to the isolated incidence of this
    rule, It is assumed that this outcome is the product of random chance and
    that over a larger number of noise pictures, the rule would hold.

Picture components
~~~~~~~~~~~~~~~~~~

The plot below compares the signal levels produced by different colour
components of the real picture signals. Again, a 4-level Le Gall (5, 3)
transform is shown acting on 10 bit inputs and 4:1 compression.

.. image:: /_static/bit_widths_colour_components.svg

..
    python ../signal-width-experiments/plot_signal_ranges.py \
        --title "4-level Le Gall (5, 3), 10-bit pictures" \
        --plot-test-pattern "Test pattern" le_gall_4_10bits.csv \
        --plot-picture "Real pictures (Y)" 2.5 \
            ../signal-width-experiments/results/images_ycbcr_16_hd_DSC_*_channel0_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture "Real pictures (Cb)" 2.5 \
            ../signal-width-experiments/results/images_ycbcr_16_hd_DSC_*_channel1_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture "Real pictures (Cr)" 2.5 \
            ../signal-width-experiments/results/images_ycbcr_16_hd_DSC_*_channel2_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture "Real pictures (R)" 2.5 \
            ../signal-width-experiments/results/images_rgb_16_hd_DSC_*_channel0_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture "Real pictures (G)" 2.5 \
            ../signal-width-experiments/results/images_rgb_16_hd_DSC_*_channel1_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture "Real pictures (B)" 2.5 \
            ../signal-width-experiments/results/images_rgb_16_hd_DSC_*_channel2_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --output docs/source/_static/bit_widths_colour_components.svg 297 110

As might be expected, the signal levels from the luma component (Y) in a YCbCr
picture and the components of an RGB picture are extremely similar. Likewise,
the colour difference signals (Cb and Cr) from a YCbCr picture show much lower
signal ranges due to relatively low signal levels encountered in typical
pictures. As a consequence, we only consider the luma component of real picture
signals in these experiments.


Picture size
~~~~~~~~~~~~

The plot below compares the signal levels produced by HD and UHD real
picture signals. Again, a 4-level Le Gall (5, 3) transform is shown acting on
10 bit inputs and 4:1 compression.

.. image:: /_static/bit_widths_picture_size.svg

..
    python ../signal-width-experiments/plot_signal_ranges.py \
        --title "4-level Le Gall (5, 3), 10-bit pictures" \
        --plot-test-pattern "Test pattern" le_gall_4_10bits.csv \
        --plot-picture "Real pictures (HD)" 2.5 \
            ../signal-width-experiments/results/images_ycbcr_16_hd_DSC_*_channel0_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture "Real pictures (UHD)" 2.5 \
            ../signal-width-experiments/results/images_ycbcr_16_uhd_DSC_*_channel0_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --output docs/source/_static/bit_widths_picture_size.svg 297 110

The signal levels encountered at the different resolutions are broadly similar
with UHD signals producing slightly larger signal levels deeper in the
transform and slightly smaller signals nearer the start/end. Due to the
similarity of the signals produced by the two picture sizes, only HD signals
are shown in the other plots.

Bit Depth
~~~~~~~~~

The plot below compares the signal levels produced by different picture bit
depths (on a relative scale). Again, a 4-level Le Gall (5, 3) transform is
shown with 4:1 compression.

.. image:: /_static/bit_widths_bit_depth.svg

..
    python ../signal-width-experiments/plot_signal_ranges.py \
        --title "4-level Le Gall (5, 3)" \
        --relative \
        --plot-test-pattern "Test pattern (8 bits)" le_gall_4_8bits.csv \
        --plot-test-pattern "Test pattern (10 bits)" le_gall_4_10bits.csv \
        --plot-test-pattern "Test pattern (12 bits)" le_gall_4_12bits.csv \
        --plot-test-pattern "Test pattern (16 bits)" le_gall_4_16bits.csv \
        --plot-picture "Real pictures (8 bits)" 2 \
            ../signal-width-experiments/results/images_ycbcr_16_hd_DSC_*_channel0_8bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture "Real pictures (10 bits)" 2.5 \
            ../signal-width-experiments/results/images_ycbcr_16_hd_DSC_*_channel0_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture "Real pictures (12 bits)" 3 \
            ../signal-width-experiments/results/images_ycbcr_16_hd_DSC_*_channel0_12bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture "Real pictures (16 bits)" 4 \
            ../signal-width-experiments/results/images_ycbcr_16_hd_DSC_*_channel0_16bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture "Saturated noise (8 bits)" 2 \
            ../signal-width-experiments/results/saturated_noise_hd_seed*_8bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture "Saturated noise (10 bits)" 2.5 \
            ../signal-width-experiments/results/saturated_noise_hd_seed*_10bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture "Saturated noise (12 bits)" 3 \
            ../signal-width-experiments/results/saturated_noise_hd_seed*_12bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --plot-picture "Saturated noise (16 bits)" 4 \
            ../signal-width-experiments/results/saturated_noise_hd_seed*_16bit_le_gall_5_3_le_gall_5_3_4_0.csv \
        --output docs/source/_static/bit_widths_bit_depth.svg 297 110

As shown, the results are essentially indistinguishable at every bit width,
though there are some occasional (small) differences which are assumed to be
due to differences in where quantisation boundaries fall. Since the impact on
bit widths on the overall trends in the results is extremely small, only 10 bit
examples are shown.


Distinctions between wavelets
`````````````````````````````

Though the trends outlined above apply broadly to all wavelets and transform
depths, some slight differences in test pattern performance between wavelets
can be discerned.

In the following plots, the distribution of test-pattern-vs-picture-or-noise
measurement is shown, broken down by wavelet transform and picture type.

.. image:: /_static/bit_width_under_estimates.svg

The key insight from this plot is that for all wavelet types and both shallow
(2-level) and deep (4-level) transforms, real picture and noise signals may
lead to an under-estimate of the bit widths required of up-to almost 4 bits
compared with the heuristic test patterns.

In almost every case, the test patterns produce larger signals than any test
picture or noise plate tested, though some exceptions exist.



Discussion
----------
